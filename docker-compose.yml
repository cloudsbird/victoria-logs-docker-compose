services:
  victoria-logs:
    image: victoriametrics/victoria-logs:v1.45.0
    container_name: victoria-logs
    ports:
      - "127.0.0.1:9428:9428"
    volumes:
      - victoria-logs-data:/victoria-logs-data
    environment:
      - VM_MEMORY_ALLOWED_PERCENT=75
    command:
      - "-storageDataPath=/victoria-logs-data"
      - "-retentionPeriod=180d"  # Adjust based on your log volume
      # Performance tuning for constrained resources
      - "-search.maxConcurrentRequests=4"  # Limit concurrent queries
      - "-loggerFormat=json"
    restart: unless-stopped
    # Resource hard limits - critical for 2C/8GB
    deploy:
      resources:
        limits:
          cpus: '2'      # Reserve 0.2 core for system/Docker
          memory: 6G       # Hard ceiling at 6GB
        reservations:
          cpus: '0.5'
          memory: 2G
    # Prevent OOM killer from taking down the container
    # Kernel will kill processes inside container before killing container itself
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9428/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  grafana:
    image: grafana/grafana:12.3-ubuntu
    container_name: grafana
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_LOG_LEVEL=info
    restart: unless-stopped
    depends_on:
      - victoria-logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  victoria-logs-data:
    driver: local
  grafana-data:
    driver: local
